openapi: 3.0.3
info:
  title: PKD Management Service API
  description: |
    ICAO Local PKD Management Service API.
    Handles certificate upload, validation, and LDAP synchronization.

    ## Changelog
    - **v1.6.2** (2026-01-15): Countries API performance optimization (LDAP → PostgreSQL, 99.9% faster)
    - **v1.6.1** (2026-01-15): Certificate export crash fix (temporary file approach)
    - **v1.6.0** (2026-01-15): Certificate search/export feature, countries list API
    - **v1.5.11** (2026-01-14): MANUAL mode localStorage bug fix
    - **v1.5.10** (2026-01-13): AUTO mode progress display with X/Total format
    - **v1.4.8** (2026-01-11): Failed upload cleanup feature
    - **v1.2.0** (2026-01-09): File duplicate detection (SHA-256)
  version: 1.6.2
  contact:
    name: SmartCore Inc.
    email: support@smartcoreinc.com

servers:
  - url: http://localhost:8081
    description: Development server
  - url: http://pkd-management:8081
    description: Docker internal

tags:
  - name: Health
    description: Health check endpoints
  - name: Upload
    description: Certificate upload operations
  - name: Validation
    description: Certificate validation operations
  - name: Certificates
    description: Certificate search and export operations
  - name: PA
    description: Passive Authentication operations
  - name: Progress
    description: Upload progress tracking
  - name: LDAP
    description: LDAP operations

paths:
  /api/health:
    get:
      tags: [Health]
      summary: Application health check
      description: Returns the overall health status of the service
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/health/database:
    get:
      tags: [Health]
      summary: Database health check
      description: Returns PostgreSQL connection status
      operationId: getDatabaseHealth
      responses:
        '200':
          description: Database connection status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseHealthResponse'

  /api/health/ldap:
    get:
      tags: [Health]
      summary: LDAP health check
      description: Returns OpenLDAP connection status
      operationId: getLdapHealth
      responses:
        '200':
          description: LDAP connection status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LdapHealthResponse'

  /api/upload/ldif:
    post:
      tags: [Upload]
      summary: Upload LDIF file
      description: |
        Upload and process an LDIF file containing certificates.

        **Processing Modes**:
        - **AUTO** (default): Automatic 1-step processing (parse + validate + LDAP upload)
        - **MANUAL**: 3-step manual processing
          1. Parse and save to temp file
          2. Validate and save to DB
          3. Upload to LDAP

        **Duplicate Detection**: Files are checked against SHA-256 hash before upload.
      operationId: uploadLdif
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: LDIF file to upload
                processing_mode:
                  type: string
                  enum: [AUTO, MANUAL]
                  default: AUTO
                  description: |
                    Processing mode for the upload:
                    - AUTO: Automatic full processing
                    - MANUAL: Manual 3-step processing
              required:
                - file
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: Invalid file or upload error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate file detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateFileResponse'

  /api/upload/masterlist:
    post:
      tags: [Upload]
      summary: Upload Master List file
      description: |
        Upload and process an ICAO Master List file (CMS signed).

        **Processing Modes**:
        - **AUTO** (default): Automatic 1-step processing (parse + validate + LDAP upload)
        - **MANUAL**: 3-step manual processing
          1. Parse and save to temp file
          2. Validate and save to DB
          3. Upload to LDAP

        **Note**: Master Lists contain only CSCA certificates per ICAO Doc 9303.
        **Duplicate Detection**: Files are checked against SHA-256 hash before upload.
      operationId: uploadMasterList
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Master List file (.ml) to upload
                processing_mode:
                  type: string
                  enum: [AUTO, MANUAL]
                  default: AUTO
                  description: |
                    Processing mode for the upload:
                    - AUTO: Automatic full processing
                    - MANUAL: Manual 3-step processing
              required:
                - file
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: Invalid file or upload error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate file detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateFileResponse'

  /api/upload/statistics:
    get:
      tags: [Upload]
      summary: Get upload statistics
      description: Returns statistics about uploaded certificates
      operationId: getUploadStatistics
      responses:
        '200':
          description: Upload statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadStatisticsResponse'

  /api/upload/history:
    get:
      tags: [Upload]
      summary: Get upload history
      description: Returns history of file uploads
      operationId: getUploadHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
          description: Maximum number of records to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Number of records to skip
      responses:
        '200':
          description: Upload history list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadHistoryResponse'

  /api/upload/countries:
    get:
      tags: [Upload]
      summary: Get country statistics
      description: Returns certificate counts by country
      operationId: getCountryStatistics
      responses:
        '200':
          description: Country statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountryStatisticsResponse'

  /api/validation/revalidate:
    post:
      tags: [Validation]
      summary: Re-validate certificates
      description: Trigger re-validation of DSC trust chains
      operationId: revalidateCertificates
      responses:
        '200':
          description: Revalidation started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevalidateResponse'

  /api/certificates/search:
    get:
      tags: [Certificates]
      summary: Search certificates
      description: |
        Search certificates in LDAP by country and type (v1.6.0+).

        **Data Source**: 100% LDAP-based (real-time search)

        **Performance**: Authenticated bind with auto-reconnect

        Returns list of certificate DNs matching the search criteria.
      operationId: searchCertificates
      parameters:
        - name: country
          in: query
          required: true
          schema:
            type: string
            minLength: 2
            maxLength: 2
          description: ISO 3166-1 alpha-2 country code (e.g., KR, US)
        - name: certType
          in: query
          required: false
          schema:
            type: string
            enum: [CSCA, DSC, DSC_NC, CRL, ML, ALL]
            default: ALL
          description: Certificate type filter
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CertificateSearchResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/certificates/countries:
    get:
      tags: [Certificates]
      summary: Get list of countries
      description: |
        Get list of all countries with registered certificates (v1.6.0+).

        **Performance**: PostgreSQL DISTINCT query (40ms avg, 99.9% faster than LDAP)

        **v1.6.2 Optimization**: Switched from LDAP scan to PostgreSQL for 1,975x speedup
      operationId: getCountries
      responses:
        '200':
          description: List of country codes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountriesResponse'

  /api/certificates/detail:
    get:
      tags: [Certificates]
      summary: Get certificate details
      description: Get detailed information for a specific certificate by DN (v1.6.0+)
      operationId: getCertificateDetail
      parameters:
        - name: dn
          in: query
          required: true
          schema:
            type: string
          description: Distinguished Name of the certificate
      responses:
        '200':
          description: Certificate details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CertificateDetailResponse'
        '404':
          description: Certificate not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/certificates/export/file:
    get:
      tags: [Certificates]
      summary: Export single certificate
      description: |
        Export a single certificate file in DER or PEM format (v1.6.0+).

        **Formats**:
        - DER: Binary format (application/x-x509-ca-cert)
        - PEM: Base64 encoded with headers (application/x-pem-file)
      operationId: exportCertificateFile
      parameters:
        - name: dn
          in: query
          required: true
          schema:
            type: string
          description: Distinguished Name of the certificate
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [DER, PEM]
            default: DER
          description: Export format
      responses:
        '200':
          description: Certificate file
          content:
            application/x-x509-ca-cert:
              schema:
                type: string
                format: binary
            application/x-pem-file:
              schema:
                type: string
        '404':
          description: Certificate not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/certificates/export/country:
    get:
      tags: [Certificates]
      summary: Export country certificates
      description: |
        Export all certificates for a country as a ZIP archive (v1.6.0+).

        **ZIP Contents**:
        - CSCA: {COUNTRY}_CSCA_{SERIAL}.crt
        - DSC: {COUNTRY}_DSC_{SERIAL}.crt
        - DSC_NC: {COUNTRY}_DSC_NC_{SERIAL}.crt
        - CRL: cn_{SHA256_HASH}.der
        - ML: {COUNTRY}_ML_{SERIAL}.crt

        **Format**: DER or PEM based on format parameter

        **v1.6.1**: Fixed ZIP creation crash with temporary file approach
      operationId: exportCountryCertificates
      parameters:
        - name: country
          in: query
          required: true
          schema:
            type: string
            minLength: 2
            maxLength: 2
          description: ISO 3166-1 alpha-2 country code
        - name: certType
          in: query
          required: false
          schema:
            type: string
            enum: [CSCA, DSC, DSC_NC, CRL, ML, ALL]
            default: ALL
          description: Certificate type filter
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [DER, PEM]
            default: DER
          description: Export format
      responses:
        '200':
          description: ZIP archive
          content:
            application/zip:
              schema:
                type: string
                format: binary
        '404':
          description: No certificates found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/upload/{uploadId}:
    delete:
      tags: [Upload]
      summary: Delete failed upload
      description: |
        Delete a failed or pending upload and clean up associated data (v1.4.8+).

        **Cleanup actions**:
        - Delete certificates from DB
        - Delete CRL records
        - Delete master list records
        - Delete upload record
        - Delete temporary JSON file

        **Note**: Only FAILED or PENDING uploads can be deleted
      operationId: deleteFailedUpload
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Upload ID to delete
      responses:
        '200':
          description: Upload deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteUploadResponse'
        '400':
          description: Cannot delete upload (not in FAILED/PENDING status)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Upload not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pa/verify:
    post:
      tags: [PA]
      summary: Verify Passive Authentication
      description: Perform ICAO 9303 Passive Authentication verification
      operationId: verifyPA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PAVerifyRequest'
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PAVerifyResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pa/statistics:
    get:
      tags: [PA]
      summary: Get PA statistics
      description: Returns Passive Authentication verification statistics
      operationId: getPAStatistics
      responses:
        '200':
          description: PA statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PAStatisticsResponse'

  /api/pa/history:
    get:
      tags: [PA]
      summary: Get PA verification history
      description: Returns history of PA verifications
      operationId: getPAHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: PA history list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PAHistoryResponse'

  /api/progress/stream/{uploadId}:
    get:
      tags: [Progress]
      summary: SSE progress stream
      description: |
        Server-Sent Events stream for upload progress.

        **Event Format**:
        ```
        event: progress
        data: {"stage":"PROCESSING","percentage":50,"message":"처리 중: CSCA 100/500, DSC 200/1000, CRL 10/50"}

        event: completed
        data: {"stage":"COMPLETED","percentage":100,"message":"처리 완료: CSCA 500개, DSC 1000개 (검증: 800 성공, 200 실패)"}
        ```

        **Stages**: UPLOADING, PARSING, PROCESSING, DB_SAVING, LDAP_UPLOADING, COMPLETED, FAILED

        **New in v1.5.10**: Detailed progress with X/Total format and completion signals
      operationId: getProgressStream
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Upload ID to track
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
              example: |
                event: progress
                data: {"stage":"PROCESSING","percentage":30,"message":"처리 중: CSCA 50/500, DSC 100/1000"}

                event: completed
                data: {"stage":"COMPLETED","percentage":100,"message":"처리 완료"}

  /api/progress/status/{uploadId}:
    get:
      tags: [Progress]
      summary: Get progress status
      description: Returns current progress status for an upload
      operationId: getProgressStatus
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Progress status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgressStatusResponse'

  /api/ldap/health:
    get:
      tags: [LDAP]
      summary: LDAP health check
      description: Returns detailed LDAP connection status
      operationId: getLdapDetailedHealth
      responses:
        '200':
          description: LDAP health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LdapHealthResponse'

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        service:
          type: string
        version:
          type: string
        timestamp:
          type: string
          format: date-time

    DatabaseHealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [connected, disconnected]
        host:
          type: string
        port:
          type: integer
        database:
          type: string
        responseTime:
          type: integer
          description: Response time in milliseconds

    LdapHealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [connected, disconnected]
        host:
          type: string
        port:
          type: integer
        baseDn:
          type: string
        responseTime:
          type: integer

    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
        uploadId:
          type: string
        filename:
          type: string
        message:
          type: string
        certificatesProcessed:
          type: integer

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          default: false
        error:
          type: string
        message:
          type: string

    DuplicateFileResponse:
      type: object
      properties:
        success:
          type: boolean
          default: false
        error:
          type: string
          example: "DUPLICATE_FILE"
        message:
          type: string
          example: "File already uploaded"
        existingUpload:
          type: object
          properties:
            uploadId:
              type: string
              format: uuid
              description: UUID of the existing upload
            filename:
              type: string
              description: Original filename of the existing upload
            uploadTimestamp:
              type: string
              format: date-time
              description: When the file was first uploaded
            status:
              type: string
              enum: [PENDING, PROCESSING, COMPLETED, FAILED]
              description: Current processing status
            processingMode:
              type: string
              enum: [AUTO, MANUAL]
              description: Processing mode used

    UploadStatisticsResponse:
      type: object
      properties:
        totalCertificates:
          type: integer
        csca:
          type: integer
        dsc:
          type: integer
        dscNc:
          type: integer
        crl:
          type: integer
        masterList:
          type: integer
        trustChainValid:
          type: integer
        trustChainInvalid:
          type: integer

    UploadHistoryResponse:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            $ref: '#/components/schemas/UploadHistoryItem'

    UploadHistoryItem:
      type: object
      properties:
        id:
          type: integer
        filename:
          type: string
        fileType:
          type: string
        uploadDate:
          type: string
          format: date-time
        status:
          type: string
        certificatesProcessed:
          type: integer

    CountryStatisticsResponse:
      type: object
      properties:
        countries:
          type: array
          items:
            $ref: '#/components/schemas/CountryStats'

    CountryStats:
      type: object
      properties:
        countryCode:
          type: string
        csca:
          type: integer
        dsc:
          type: integer
        crl:
          type: integer

    RevalidateResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        validatedCount:
          type: integer

    PAVerifyRequest:
      type: object
      required:
        - sod
        - dataGroups
      properties:
        sod:
          type: string
          description: Base64 encoded SOD (Security Object Document)
        dataGroups:
          type: object
          additionalProperties:
            type: string
          description: Map of DG number to Base64 encoded data
        mrzData:
          type: string
          description: Optional MRZ data for additional validation

    PAVerifyResponse:
      type: object
      properties:
        success:
          type: boolean
        verificationId:
          type: string
        steps:
          type: array
          items:
            $ref: '#/components/schemas/PAVerificationStep'
        documentInfo:
          $ref: '#/components/schemas/DocumentInfo'

    PAVerificationStep:
      type: object
      properties:
        step:
          type: integer
        name:
          type: string
        status:
          type: string
          enum: [passed, failed, skipped]
        message:
          type: string

    DocumentInfo:
      type: object
      properties:
        documentType:
          type: string
        issuingCountry:
          type: string
        documentNumber:
          type: string
        expiryDate:
          type: string

    PAStatisticsResponse:
      type: object
      properties:
        totalVerifications:
          type: integer
        successCount:
          type: integer
        failureCount:
          type: integer
        byCountry:
          type: object
          additionalProperties:
            type: integer

    PAHistoryResponse:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            $ref: '#/components/schemas/PAHistoryItem'

    PAHistoryItem:
      type: object
      properties:
        id:
          type: string
        verificationDate:
          type: string
          format: date-time
        issuingCountry:
          type: string
        documentType:
          type: string
        result:
          type: string
          enum: [success, failure]

    ProgressStatusResponse:
      type: object
      properties:
        uploadId:
          type: string
        stage:
          type: string
        progress:
          type: integer
          minimum: 0
          maximum: 100
        message:
          type: string
        isComplete:
          type: boolean

    CertificateSearchResponse:
      type: object
      description: Certificate search results (v1.6.0+)
      properties:
        success:
          type: boolean
        country:
          type: string
        certType:
          type: string
        total:
          type: integer
        certificates:
          type: array
          items:
            type: object
            properties:
              dn:
                type: string
                description: Distinguished Name
              cn:
                type: string
                description: Common Name
              serialNumber:
                type: string
                description: Certificate serial number

    CountriesResponse:
      type: object
      description: List of countries with certificates (v1.6.0+)
      properties:
        success:
          type: boolean
        total:
          type: integer
        countries:
          type: array
          items:
            type: string
            description: ISO 3166-1 alpha-2 country code
          example: ["KR", "US", "JP", "CN"]

    CertificateDetailResponse:
      type: object
      description: Detailed certificate information (v1.6.0+)
      properties:
        success:
          type: boolean
        dn:
          type: string
        certificate:
          type: object
          properties:
            subject:
              type: string
            issuer:
              type: string
            serialNumber:
              type: string
            notBefore:
              type: string
              format: date-time
            notAfter:
              type: string
              format: date-time
            countryCode:
              type: string
            certificateType:
              type: string
              enum: [CSCA, DSC, DSC_NC, CRL, ML]
            size:
              type: integer
              description: Certificate size in bytes

    DeleteUploadResponse:
      type: object
      description: Result of upload deletion (v1.4.8+)
      properties:
        success:
          type: boolean
        message:
          type: string
        deletedRecords:
          type: object
          properties:
            certificates:
              type: integer
            crls:
              type: integer
            masterLists:
              type: integer
            uploadRecord:
              type: integer
            tempFiles:
              type: integer
