openapi: 3.0.3
info:
  title: PKD Management Service API
  description: |
    ICAO Local PKD Management Service API.
    Handles certificate upload, validation, search, authentication, and LDAP synchronization.

    ## Changelog
    - **v2.9.1** (2026-02-13): Certificate source filter, bySource statistics, DB-based search
    - **v2.7.0** (2026-02-12): Individual certificate upload with preview-before-save
    - **v2.5.0** (2026-02-06): Oracle + PostgreSQL multi-DBMS support
    - **v1.9.0** (2026-01-30): JWT authentication + RBAC
    - **v1.7.0** (2026-01-20): ICAO Auto Sync - Version comparison API
    - **v1.6.0** (2026-01-15): Certificate search/export, countries list API
    - **v1.5.10** (2026-01-13): AUTO mode progress display with X/Total format
    - **v1.4.8** (2026-01-11): Failed upload cleanup feature
  version: 2.9.1
  contact:
    name: SmartCore Inc.
    email: support@smartcoreinc.com

servers:
  - url: http://localhost:8081
    description: Development server (direct)
  - url: http://localhost:8080
    description: API Gateway

tags:
  - name: Health
    description: Health check endpoints
  - name: Upload
    description: Certificate upload operations (LDIF, Master List, Individual)
  - name: Certificates
    description: Certificate search and export operations
  - name: Auth
    description: Authentication and user management
  - name: Audit
    description: Operation audit logging
  - name: ICAO
    description: ICAO PKD version monitoring and comparison
  - name: Progress
    description: Upload progress tracking (SSE)

paths:
  # ============================================
  # Health Endpoints
  # ============================================
  /api/health:
    get:
      tags: [Health]
      summary: Application health check
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/health/database:
    get:
      tags: [Health]
      summary: Database health check
      operationId: getDatabaseHealth
      responses:
        '200':
          description: Database connection status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseHealthResponse'

  /api/health/ldap:
    get:
      tags: [Health]
      summary: LDAP health check
      operationId: getLdapHealth
      responses:
        '200':
          description: LDAP connection status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LdapHealthResponse'

  # ============================================
  # Upload Endpoints
  # ============================================
  /api/upload/ldif:
    post:
      tags: [Upload]
      summary: Upload LDIF file
      description: |
        Upload and process an LDIF file containing certificates.
        Supports AUTO (1-step) and MANUAL (3-step) processing modes.
        Duplicate detection via SHA-256 file hash.
      operationId: uploadLdif
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                processing_mode:
                  type: string
                  enum: [AUTO, MANUAL]
                  default: AUTO
              required: [file]
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '409':
          description: Duplicate file detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateFileResponse'

  /api/upload/masterlist:
    post:
      tags: [Upload]
      summary: Upload Master List file
      description: Upload and process an ICAO Master List file (CMS signed). Contains CSCA certificates.
      operationId: uploadMasterList
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                processing_mode:
                  type: string
                  enum: [AUTO, MANUAL]
                  default: AUTO
              required: [file]
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '409':
          description: Duplicate file detected

  /api/upload/certificate:
    post:
      tags: [Upload]
      summary: Upload individual certificate
      description: |
        Upload a single certificate file (PEM, DER, CER, P7B, DL, CRL).
        Saves to database and LDAP. Use `/api/upload/certificate/preview` first to preview.
      operationId: uploadCertificate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required: [file]
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'

  /api/upload/certificate/preview:
    post:
      tags: [Upload]
      summary: Preview certificate (parse only)
      description: |
        Parse and preview a certificate file without saving.
        Returns certificate details, metadata, and validation info.
        Supports PEM, DER, CER, P7B, DL (Deviation List), CRL formats.
      operationId: previewCertificate
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required: [file]
      responses:
        '200':
          description: Certificate preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  certificates:
                    type: array
                    items:
                      $ref: '#/components/schemas/CertificatePreview'

  /api/upload/statistics:
    get:
      tags: [Upload]
      summary: Get upload statistics
      description: |
        Returns certificate counts by type, validation status, and source.
        Includes `bySource` field with certificate counts per source_type.
      operationId: getUploadStatistics
      responses:
        '200':
          description: Upload statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadStatisticsResponse'

  /api/upload/history:
    get:
      tags: [Upload]
      summary: Get upload history
      operationId: getUploadHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Upload history list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadHistoryResponse'

  /api/upload/detail/{uploadId}:
    get:
      tags: [Upload]
      summary: Get upload detail
      operationId: getUploadDetail
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Upload detail
        '404':
          description: Upload not found

  /api/upload/{uploadId}:
    delete:
      tags: [Upload]
      summary: Delete failed upload
      description: Only FAILED or PENDING uploads can be deleted. Cleans up certificates, CRLs, and temp files.
      operationId: deleteUpload
      security:
        - bearerAuth: []
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Upload deleted
        '400':
          description: Cannot delete (not FAILED/PENDING)
        '404':
          description: Upload not found

  /api/upload/{uploadId}/validations:
    get:
      tags: [Upload]
      summary: Get trust chain validation results
      operationId: getUploadValidations
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Validation results

  /api/upload/{uploadId}/validation-statistics:
    get:
      tags: [Upload]
      summary: Get validation statistics for upload
      operationId: getUploadValidationStatistics
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Validation statistics

  /api/upload/{uploadId}/issues:
    get:
      tags: [Upload]
      summary: Get duplicate certificates detected
      operationId: getUploadIssues
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Issue list

  /api/upload/{uploadId}/ldif-structure:
    get:
      tags: [Upload]
      summary: Get LDIF/ASN.1 structure
      description: Returns the parsed structure of an LDIF file as a tree.
      operationId: getLdifStructure
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: LDIF structure tree

  /api/upload/{uploadId}/masterlist-structure:
    get:
      tags: [Upload]
      summary: Get Master List structure
      description: Returns parsed ASN.1 structure of a Master List file.
      operationId: getMasterListStructure
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Master List structure tree

  /api/upload/countries:
    get:
      tags: [Upload]
      summary: Get country statistics (dashboard)
      operationId: getCountryStatistics
      responses:
        '200':
          description: Country statistics

  /api/upload/countries/detailed:
    get:
      tags: [Upload]
      summary: Get detailed country breakdown
      operationId: getDetailedCountryStatistics
      responses:
        '200':
          description: Detailed country breakdown with certificate types

  /api/upload/changes:
    get:
      tags: [Upload]
      summary: Get recent upload changes
      operationId: getUploadChanges
      responses:
        '200':
          description: Recent changes

  # ============================================
  # Certificate Search & Export
  # ============================================
  /api/certificates/search:
    get:
      tags: [Certificates]
      summary: Search certificates
      description: |
        Search certificates by country, type, status, and source.
        When `source` is specified, uses DB-based search.
        When `source` is not specified, uses LDAP-based search.
      operationId: searchCertificates
      parameters:
        - name: country
          in: query
          schema:
            type: string
            minLength: 2
            maxLength: 2
          description: ISO 3166-1 alpha-2 country code
        - name: certType
          in: query
          schema:
            type: string
            enum: [CSCA, DSC, DSC_NC, CRL, ML, ALL]
            default: ALL
        - name: source
          in: query
          schema:
            type: string
            enum: [LDIF_PARSED, ML_PARSED, FILE_UPLOAD, PA_EXTRACTED, DL_PARSED]
          description: Certificate source type filter (triggers DB search)
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CertificateSearchResponse'

  /api/certificates/countries:
    get:
      tags: [Certificates]
      summary: Get country list
      operationId: getCountries
      responses:
        '200':
          description: List of country codes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CountriesResponse'

  /api/certificates/detail:
    get:
      tags: [Certificates]
      summary: Get certificate details
      operationId: getCertificateDetail
      parameters:
        - name: dn
          in: query
          required: true
          schema:
            type: string
          description: Distinguished Name
      responses:
        '200':
          description: Certificate details
        '404':
          description: Not found

  /api/certificates/validation:
    get:
      tags: [Certificates]
      summary: Get validation result by fingerprint
      operationId: getCertificateValidation
      parameters:
        - name: fingerprint
          in: query
          required: true
          schema:
            type: string
          description: SHA-256 fingerprint
      responses:
        '200':
          description: Validation result

  /api/certificates/export/file:
    get:
      tags: [Certificates]
      summary: Export single certificate (DER/PEM)
      operationId: exportCertificateFile
      parameters:
        - name: dn
          in: query
          required: true
          schema:
            type: string
        - name: format
          in: query
          schema:
            type: string
            enum: [DER, PEM]
            default: DER
      responses:
        '200':
          description: Certificate file
          content:
            application/x-x509-ca-cert:
              schema:
                type: string
                format: binary

  /api/certificates/export/country:
    get:
      tags: [Certificates]
      summary: Export country certificates as ZIP
      operationId: exportCountryCertificates
      parameters:
        - name: country
          in: query
          required: true
          schema:
            type: string
        - name: certType
          in: query
          schema:
            type: string
            enum: [CSCA, DSC, DSC_NC, CRL, ML, ALL]
            default: ALL
        - name: format
          in: query
          schema:
            type: string
            enum: [DER, PEM]
            default: DER
      responses:
        '200':
          description: ZIP archive
          content:
            application/zip:
              schema:
                type: string
                format: binary

  # ============================================
  # Authentication & User Management
  # ============================================
  /api/auth/login:
    post:
      tags: [Auth]
      summary: User login
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
              required: [username, password]
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/UserInfo'

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: User logout
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful

  /api/auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh JWT token
      operationId: refreshToken
      security:
        - bearerAuth: []
      responses:
        '200':
          description: New token
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  token:
                    type: string

  /api/auth/me:
    get:
      tags: [Auth]
      summary: Get current user info
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'

  /api/auth/users:
    get:
      tags: [Auth]
      summary: List all users (admin only)
      operationId: listUsers
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User list
    post:
      tags: [Auth]
      summary: Create user (admin only)
      operationId: createUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
                role:
                  type: string
                  enum: [admin, user]
              required: [username, password, role]
      responses:
        '201':
          description: User created

  /api/auth/users/{userId}:
    get:
      tags: [Auth]
      summary: Get user by ID (admin only)
      operationId: getUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User info
    put:
      tags: [Auth]
      summary: Update user (admin only)
      operationId: updateUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  type: string
                active:
                  type: boolean
      responses:
        '200':
          description: User updated
    delete:
      tags: [Auth]
      summary: Delete user (admin only)
      operationId: deleteUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User deleted

  /api/auth/users/{userId}/password:
    put:
      tags: [Auth]
      summary: Change user password (admin only)
      operationId: changePassword
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                newPassword:
                  type: string
              required: [newPassword]
      responses:
        '200':
          description: Password changed

  /api/auth/audit-log:
    get:
      tags: [Auth]
      summary: Get auth audit logs (admin only)
      operationId: getAuthAuditLog
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Auth audit log entries

  /api/auth/audit-log/stats:
    get:
      tags: [Auth]
      summary: Get auth audit statistics (admin only)
      operationId: getAuthAuditStats
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Auth audit statistics

  # ============================================
  # Operation Audit
  # ============================================
  /api/audit/operations:
    get:
      tags: [Audit]
      summary: Get operation audit logs
      operationId: getOperationAuditLogs
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Operation audit log entries

  /api/audit/operations/stats:
    get:
      tags: [Audit]
      summary: Get operation audit statistics
      operationId: getOperationAuditStats
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Operation statistics

  # ============================================
  # ICAO Version Monitoring
  # ============================================
  /api/icao/check-updates:
    get:
      tags: [ICAO]
      summary: Check for ICAO PKD updates
      description: Trigger a check for new ICAO PKD versions from the ICAO portal.
      operationId: checkIcaoUpdates
      responses:
        '200':
          description: Check completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  new_version_count:
                    type: integer
                  new_versions:
                    type: array
                    items:
                      $ref: '#/components/schemas/IcaoVersion'

  /api/icao/status:
    get:
      tags: [ICAO]
      summary: Get version comparison status
      description: Compare detected ICAO PKD versions with uploaded versions.
      operationId: getIcaoStatus
      responses:
        '200':
          description: Version comparison

  /api/icao/latest:
    get:
      tags: [ICAO]
      summary: Get latest detected versions
      operationId: getIcaoLatest
      responses:
        '200':
          description: Latest versions

  /api/icao/history:
    get:
      tags: [ICAO]
      summary: Get version detection history
      operationId: getIcaoHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Version history

  # ============================================
  # Progress Tracking (SSE)
  # ============================================
  /api/progress/stream/{uploadId}:
    get:
      tags: [Progress]
      summary: SSE progress stream
      description: Server-Sent Events stream for upload progress.
      operationId: getProgressStream
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string

  /api/progress/status/{uploadId}:
    get:
      tags: [Progress]
      summary: Get progress status
      operationId: getProgressStatus
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Progress status

  # ============================================
  # Validation
  # ============================================
  /api/validation/revalidate:
    post:
      tags: [Certificates]
      summary: Re-validate DSC trust chains
      operationId: revalidateCertificates
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Revalidation started

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /api/auth/login

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: UP
        service:
          type: string
        version:
          type: string
        timestamp:
          type: string

    DatabaseHealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [connected, disconnected]
        host:
          type: string
        port:
          type: integer
        database:
          type: string
        responseTime:
          type: integer

    LdapHealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [connected, disconnected]
        host:
          type: string
        port:
          type: integer
        baseDn:
          type: string

    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
        uploadId:
          type: string
          format: uuid
        filename:
          type: string
        message:
          type: string
        certificatesProcessed:
          type: integer

    DuplicateFileResponse:
      type: object
      properties:
        success:
          type: boolean
          default: false
        error:
          type: string
          example: DUPLICATE_FILE
        existingUpload:
          type: object
          properties:
            uploadId:
              type: string
              format: uuid
            filename:
              type: string
            uploadTimestamp:
              type: string
            status:
              type: string

    CertificatePreview:
      type: object
      properties:
        subject:
          type: string
        issuer:
          type: string
        serialNumber:
          type: string
        notBefore:
          type: string
        notAfter:
          type: string
        certificateType:
          type: string
          enum: [CSCA, DSC, MLSC, CRL]
        countryCode:
          type: string
        fingerprintSha256:
          type: string

    UploadStatisticsResponse:
      type: object
      properties:
        totalCertificates:
          type: integer
        csca:
          type: integer
        dsc:
          type: integer
        dscNc:
          type: integer
        crl:
          type: integer
        masterList:
          type: integer
        trustChainValid:
          type: integer
        trustChainInvalid:
          type: integer
        bySource:
          type: object
          description: Certificate count by source_type
          additionalProperties:
            type: integer
          example:
            LDIF_PARSED: 30675
            ML_PARSED: 536
            PA_EXTRACTED: 1

    UploadHistoryResponse:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              filename:
                type: string
              fileType:
                type: string
              uploadDate:
                type: string
              status:
                type: string
              certificatesProcessed:
                type: integer

    CertificateSearchResponse:
      type: object
      properties:
        success:
          type: boolean
        country:
          type: string
        certType:
          type: string
        total:
          type: integer
        certificates:
          type: array
          items:
            type: object
            properties:
              dn:
                type: string
              cn:
                type: string
              serialNumber:
                type: string
              subjectDn:
                type: string
              issuerDn:
                type: string
              countryCode:
                type: string
              certificateType:
                type: string
              sourceType:
                type: string
              notBefore:
                type: string
              notAfter:
                type: string

    CountriesResponse:
      type: object
      properties:
        success:
          type: boolean
        total:
          type: integer
        countries:
          type: array
          items:
            type: string
          example: ["KR", "US", "JP"]

    UserInfo:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        role:
          type: string
          enum: [admin, user]
        active:
          type: boolean

    IcaoVersion:
      type: object
      properties:
        id:
          type: integer
        collection_type:
          type: string
          enum: [DSC_CRL, DSC_NC, MASTERLIST]
        file_name:
          type: string
        file_version:
          type: integer
        status:
          type: string
          enum: [DETECTED, NOTIFIED, DOWNLOADED, IMPORTED, FAILED]
        detected_at:
          type: string
          format: date-time
