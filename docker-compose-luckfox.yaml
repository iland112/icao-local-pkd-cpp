# =============================================================================
# ICAO Local PKD C++ - Luckfox ARM64 Deployment
# =============================================================================
# Network Architecture:
#   192.168.100.10: OpenLDAP1 (:389) - Master Node
#   192.168.100.11: OpenLDAP2 (:389) + Docker Apps - This Node
#
# LDAP Strategy (v2.0.1+):
#   - Applications use direct connections to both LDAP servers
#   - Application-level load balancing (no HAProxy)
#
# Network Isolation (Phase 4.3):
#   - frontend network: External access (API Gateway, Frontend)
#   - backend network: Internal only (PKD, PA, Sync services, PostgreSQL)
#   - PostgreSQL and services not directly accessible from host
# =============================================================================

# Network definitions (Phase 4.3 - Security Hardening)
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true  # No internet access for backend services

services:
  # ---------------------------------------------------------------------------
  # API Gateway (Nginx)
  # ---------------------------------------------------------------------------
  api-gateway:
    image: nginx:alpine
    container_name: icao-pkd-api-gateway
    networks:
      - frontend
      - backend
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/api-gateway-luckfox.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - pkd-management
      - pa-service
      - pkd-relay
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Frontend (React.js)
  # ---------------------------------------------------------------------------
  frontend:
    image: icao-local-pkd-frontend:arm64
    container_name: icao-pkd-frontend
    networks:
      - frontend
    ports:
      - "80:80"
    environment:
      - TZ=Asia/Seoul
    volumes:
      - ./frontend/nginx-luckfox.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api-gateway
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PKD Management Service
  # ---------------------------------------------------------------------------
  pkd-management:
    image: icao-local-management:arm64
    container_name: icao-pkd-management
    networks:
      - backend
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=pkd-management
      - SERVER_PORT=8081
      # PostgreSQL (bridge network - use service name)
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=localpkd
      - DB_USER=pkd
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      # LDAP - Direct connections to both servers (v2.0.1+)
      - LDAP_READ_HOSTS=192.168.100.10:389,192.168.100.11:389
      - LDAP_WRITE_HOST=192.168.100.10
      - LDAP_WRITE_PORT=389
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}  # From .env file
      - LDAP_BASE_DN=dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
      - TRUST_ANCHOR_PATH=/app/data/cert/UN_CSCA_2.pem
      # JWT Authentication (Phase 3)
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}          # From .env file (REQUIRED)
      - JWT_ISSUER=${JWT_ISSUER:-icao-pkd}        # Default: icao-pkd
      - JWT_EXPIRATION_SECONDS=${JWT_EXPIRATION_SECONDS:-3600}  # Default: 3600 (1 hour)
      - AUTH_ENABLED=${AUTH_ENABLED:-true}        # Default: true (NEVER disable in production)
    depends_on:
      - postgres
    volumes:
      - ./.docker-data/pkd-logs:/app/logs
      - ./.docker-data/pkd-uploads:/app/uploads
      - ./data/cert:/app/data/cert:ro
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PA Service (Passive Authentication)
  # ---------------------------------------------------------------------------
  pa-service:
    image: icao-local-pa:arm64
    container_name: icao-pkd-pa-service
    networks:
      - backend
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=pa-service
      - SERVER_PORT=8082
      # PostgreSQL (bridge network - use service name)
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=localpkd
      - DB_USER=pkd
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      # LDAP - Direct connections to both servers (v2.0.1+)
      - LDAP_READ_HOSTS=192.168.100.10:389,192.168.100.11:389
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}  # From .env file
      - LDAP_BASE_DN=dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
    depends_on:
      - postgres
    volumes:
      - ./.docker-data/pa-logs:/app/logs
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PKD Relay Service (formerly Sync Service)
  # ---------------------------------------------------------------------------
  pkd-relay:
    image: icao-local-pkd-relay:arm64
    container_name: icao-pkd-relay
    networks:
      - backend
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=pkd-relay
      - SERVER_PORT=8083
      # PostgreSQL (bridge network - use service name)
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=localpkd
      - DB_USER=pkd
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      # LDAP - Direct connections to both servers (v2.0.1+)
      - LDAP_READ_HOSTS=192.168.100.10:389,192.168.100.11:389
      - LDAP_WRITE_HOST=192.168.100.10
      - LDAP_WRITE_PORT=389
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}  # From .env file
      - LDAP_BASE_DN=dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
    depends_on:
      - postgres
    volumes:
      - ./.docker-data/sync-logs:/app/logs
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Swagger UI (API Documentation)
  # ---------------------------------------------------------------------------
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: icao-pkd-swagger
    networks:
      - frontend
    ports:
      - "8888:8888"
    environment:
      - PORT=8888
      - BASE_URL=/api-docs
      - URLS=[{"url":"api/docs/pkd-management.yaml","name":"PKD Management API v1.5.10"},{"url":"api/docs/pa-service.yaml","name":"PA Service API v1.2.0"},{"url":"api/docs/pkd-relay-service.yaml","name":"PKD Relay Service API v2.0.0"}]
      - URLS_PRIMARY_NAME=PKD Management API v1.5.10
      - TZ=Asia/Seoul
    volumes:
      - ./docs/openapi:/usr/share/nginx/html/api/docs:ro
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15
    container_name: icao-pkd-postgres
    networks:
      - backend
    # No ports exposed - backend services only
    environment:
      - POSTGRES_USER=pkd
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}  # From .env file (same as DB_PASSWORD)
      - POSTGRES_DB=localpkd
      - TZ=Asia/Seoul
    volumes:
      - ./.docker-data/postgres:/var/lib/postgresql/data
      - ./docker/init-scripts:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
