# =============================================================================
# ICAO Local PKD - Docker Compose Configuration
# Multi-Service Architecture: PKD Management + PA Service + PKD Relay Service
# =============================================================================
# Data Directory: .docker-data/ (bind mount for easy management)
# To reset: rm -rf .docker-data && docker compose up -d
# =============================================================================
# API Gateway: http://localhost:8080/api/* (unified API entry point)
# Frontend:    http://localhost:3000 (React SPA)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Shared vcpkg Base Image (build once, reused by all C++ services)
  # Usage: docker compose build vcpkg-base  (first, then build services)
  # ---------------------------------------------------------------------------
  vcpkg-base:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vcpkg-base
    image: icao-vcpkg-base:latest
    profiles:
      - build-only  # Never runs as a container, only builds the image

  # ---------------------------------------------------------------------------
  # API Gateway (Nginx - Unified API Entry Point)
  # ---------------------------------------------------------------------------
  api-gateway:
    image: nginx:alpine
    container_name: icao-local-pkd-api-gateway
    ports:
      - "8080:8080"
    volumes:
      - ../nginx/api-gateway.conf:/etc/nginx/nginx.conf:ro
      - ../nginx/proxy_params:/etc/nginx/proxy_params:ro
      - ../docs/openapi:/etc/nginx/openapi:ro
      - ../.docker-data/gateway-logs:/var/log/nginx
    depends_on:
      pkd-management:
        condition: service_healthy
      pa-service:
        condition: service_healthy
      pkd-relay:
        condition: service_healthy
      # monitoring-service: moved to profiles: [postgres] (not available in oracle mode)
    networks:
      - pkd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Frontend (React.js)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: icao-local-pkd-frontend
    ports:
      - "3000:80"
    environment:
      - TZ=Asia/Seoul
    depends_on:
      - pkd-management
      - pa-service
    networks:
      - pkd-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PKD Management Service (File Upload, Parsing, Certificate Validation)
  # ---------------------------------------------------------------------------
  pkd-management:
    build:
      context: ..
      dockerfile: services/pkd-management/Dockerfile
    # image: icao-pkd-management:test-v1.7.0-parser-fix  # Using test image with ICAO Auto Sync
    container_name: icao-local-pkd-management
    # ports:
    #   - "8081:8081"  # Direct access (use API Gateway instead)
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=pkd-management
      - SERVER_PORT=8081
      # Database Type Selection (Phase 4.4)
      - DB_TYPE=${DB_TYPE}                      # postgres or oracle
      # PostgreSQL Configuration
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      # Oracle Configuration (Phase 4.4)
      - ORACLE_HOST=${ORACLE_HOST}
      - ORACLE_PORT=${ORACLE_PORT}
      - ORACLE_SERVICE_NAME=${ORACLE_SERVICE_NAME}
      - ORACLE_USER=${ORACLE_USER}
      - ORACLE_PASSWORD=${ORACLE_PASSWORD}
      - LDAP_READ_HOSTS=openldap1:389,openldap2:389  # v2.0.1: Application-level load balancing
      - LDAP_WRITE_HOST=openldap1   # Write operations direct to primary master
      - LDAP_WRITE_PORT=389
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}  # From .env file
      - LDAP_BASE_DN=dc=download,dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_DATA_CONTAINER=dc=data          # Container for normal certificates
      - LDAP_NC_DATA_CONTAINER=dc=nc-data    # Container for non-conformant certificates
      - TRUST_ANCHOR_PATH=/app/data/cert/UN_CSCA_2.pem
      # JWT Authentication (Phase 3)
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}          # From .env file (REQUIRED)
      - JWT_ISSUER=${JWT_ISSUER:-icao-pkd}        # Default: icao-pkd
      - JWT_EXPIRATION_SECONDS=${JWT_EXPIRATION_SECONDS:-3600}  # Default: 3600 (1 hour)
      - AUTH_ENABLED=${AUTH_ENABLED:-true}        # Default: true (NEVER disable in production)
      # ASN.1 Parser Configuration
      - ASN1_MAX_LINES=${ASN1_MAX_LINES:-100}     # Default: 100 (max lines for Master List structure parsing)
    depends_on:
      # DB dependency removed: services handle DB connection via DB_TYPE (postgres/oracle)
      # DB container startup is managed by scripts (--profile postgres or --profile oracle)
      openldap1:
        condition: service_healthy
      openldap2:
        condition: service_healthy
    volumes:
      - ../.docker-data/pkd-logs:/app/logs
      - ../.docker-data/pkd-uploads:/app/uploads
      - ../data/cert:/app/data/cert:ro
    networks:
      - pkd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s  # Increased to 3min to allow cache initialization (~2min for 30k certs)

  # ---------------------------------------------------------------------------
  # PA Service (Passive Authentication Verification)
  # ---------------------------------------------------------------------------
  pa-service:
    build:
      context: ..
      dockerfile: services/pa-service/Dockerfile
    container_name: icao-local-pkd-pa-service
    # ports:
    #   - "8082:8082"  # Direct access (use API Gateway instead)
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=pa-service
      - SERVER_PORT=8082
      # Database Type Selection (Phase 4.4)
      - DB_TYPE=${DB_TYPE}                      # postgres or oracle
      # PostgreSQL Configuration
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      # Oracle Configuration (Phase 4.4)
      - ORACLE_HOST=${ORACLE_HOST}
      - ORACLE_PORT=${ORACLE_PORT}
      - ORACLE_SERVICE_NAME=${ORACLE_SERVICE_NAME}
      - ORACLE_USER=${ORACLE_USER}
      - ORACLE_PASSWORD=${ORACLE_PASSWORD}
      - LDAP_HOST=openldap1                          # PA service reads LDAP_HOST (single host)
      - LDAP_PORT=389
      - LDAP_READ_HOSTS=openldap1:389,openldap2:389  # v2.0.1: Application-level load balancing
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}  # From .env file
      - LDAP_BASE_DN=dc=download,dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
    depends_on:
      openldap1:
        condition: service_healthy
      openldap2:
        condition: service_healthy
    volumes:
      - ../.docker-data/pa-logs:/app/logs
    networks:
      - pkd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # PKD Relay Service (Data Relay Layer)
  # - ICAO Portal Monitoring
  # - File Upload & Parsing
  # - DB-LDAP Sync Monitoring
  # ---------------------------------------------------------------------------
  pkd-relay:
    build:
      context: ..
      dockerfile: services/pkd-relay-service/Dockerfile
    container_name: icao-local-pkd-relay
    # ports:
    #   - "8083:8083"  # Direct access (use API Gateway instead)
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=pkd-relay
      - SERVER_PORT=8083
      # Database Type Selection (Phase 5.2)
      - DB_TYPE=${DB_TYPE}                      # postgres or oracle
      # PostgreSQL Configuration
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      # Oracle Configuration (Phase 5.2)
      - ORACLE_HOST=${ORACLE_HOST}
      - ORACLE_PORT=${ORACLE_PORT}
      - ORACLE_SERVICE_NAME=${ORACLE_SERVICE_NAME}
      - ORACLE_USER=${ORACLE_USER}
      - ORACLE_PASSWORD=${ORACLE_PASSWORD}
      - LDAP_READ_HOSTS=openldap1:389,openldap2:389  # v2.0.1: Application-level load balancing
      - LDAP_WRITE_HOST=openldap1
      - LDAP_WRITE_PORT=389
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}  # From .env file
      - LDAP_BASE_DN=dc=download,dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
      # LDAP DIT Structure (runtime configurable)
      - LDAP_DATA_CONTAINER=${LDAP_DATA_CONTAINER:-dc=data}         # Default: dc=data
      - LDAP_NC_DATA_CONTAINER=${LDAP_NC_DATA_CONTAINER:-dc=nc-data}  # Default: dc=nc-data
      - SYNC_INTERVAL_MINUTES=5
      - AUTO_RECONCILE=true
      - MAX_RECONCILE_BATCH_SIZE=100
    depends_on:
      openldap1:
        condition: service_healthy
      openldap2:
        condition: service_healthy
    volumes:
      - ../.docker-data/sync-logs:/app/logs
    networks:
      - pkd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/api/sync/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ---------------------------------------------------------------------------
  # Monitoring Service (System Metrics + Service Health Monitoring)
  # NOTE: Currently PostgreSQL-only. Not available in Oracle mode.
  # ---------------------------------------------------------------------------
  monitoring-service:
    build:
      context: ..
      dockerfile: services/monitoring-service/Dockerfile
    container_name: icao-local-pkd-monitoring
    profiles:
      - postgres  # Only starts in PostgreSQL mode (monitoring-service only supports postgres)
    # ports:
    #   - "8084:8084"  # Direct access (use API Gateway instead)
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=monitoring-service
      - SERVER_PORT=8084
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=localpkd
      - DB_USER=pkd
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      - SYSTEM_METRICS_INTERVAL=5
      - SERVICE_HEALTH_INTERVAL=30
      - SERVICE_PKD_MANAGEMENT=http://pkd-management:8081/api/health
      - SERVICE_PA_SERVICE=http://pa-service:8082/api/health
      - SERVICE_SYNC_SERVICE=http://pkd-relay:8083/api/sync/health
    depends_on:
      postgres:
        condition: service_healthy
      pkd-management:
        condition: service_healthy
      pa-service:
        condition: service_healthy
      pkd-relay:
        condition: service_healthy
    volumes:
      - ../.docker-data/monitoring-logs:/app/logs
    networks:
      - pkd-network
    restart: unless-stopped
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8084/api/monitoring/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 15s

  # ---------------------------------------------------------------------------
  # Legacy App (Backwards compatibility - uses existing Dockerfile)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: icao-local-pkd-app
    ports:
      - "8080:8081"
    environment:
      - TZ=Asia/Seoul
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=localpkd
      - DB_USER=pkd
      - DB_PASSWORD=${DB_PASSWORD}              # From .env file
      - LDAP_READ_HOSTS=openldap1:389,openldap2:389  # v2.0.1: Application-level load balancing
      - LDAP_WRITE_HOST=openldap1
      - LDAP_WRITE_PORT=389
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}  # From .env file
      - LDAP_BASE_DN=dc=download,dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
    depends_on:
      postgres:
        condition: service_healthy
      openldap1:
        condition: service_healthy
      openldap2:
        condition: service_healthy
    volumes:
      - ../.docker-data/app-logs:/app/logs
      - ../.docker-data/app-uploads:/app/uploads
      - ../data/cert:/app/data/cert:ro
    networks:
      - pkd-network
    restart: unless-stopped
    profiles:
      - legacy  # Only starts with: docker-compose --profile legacy up

  # ---------------------------------------------------------------------------
  # PostgreSQL Database (starts with --profile postgres)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15
    container_name: icao-local-pkd-postgres
    profiles:
      - postgres  # Only starts with: docker compose --profile postgres up
    ports:
      - "15432:5432"  # External: 15432, Internal: 5432 (WSL2 port forwarding workaround)
    environment:
      - POSTGRES_USER=pkd
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}  # From .env file (same as DB_PASSWORD)
      - POSTGRES_DB=localpkd
      - TZ=Asia/Seoul
      - PGTZ=Asia/Seoul
    volumes:
      - ../.docker-data/postgres:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - pkd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pkd -d localpkd"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Oracle Database XE 21c (Optional - for testing Oracle support)
  # ---------------------------------------------------------------------------
  oracle:
    image: container-registry.oracle.com/database/express:21.3.0-xe
    container_name: icao-local-pkd-oracle
    ports:
      - "11521:1521"  # External: 11521, Internal: 1521
      - "15500:5500"  # Oracle Enterprise Manager Express
    environment:
      - ORACLE_PWD=${ORACLE_PASSWORD}          # From .env file (SYS/SYSTEM password)
      - ORACLE_CHARACTERSET=AL32UTF8           # UTF-8 encoding
      - TZ=Asia/Seoul
    volumes:
      - oracle-data:/opt/oracle/oradata  # Named volume (auto-manages permissions)
      - ./db-oracle/init:/opt/oracle/scripts/startup:ro  # Initialization scripts
    networks:
      - pkd-network
    healthcheck:
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM DUAL;' | sqlplus -s sys/${ORACLE_PASSWORD}@//localhost:1521/XE as sysdba | grep -q 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s  # Oracle takes 3-5 minutes to initialize first time
    restart: unless-stopped
    shm_size: 1g  # Shared memory for Oracle
    profiles:
      - oracle  # Only starts with: docker compose --profile oracle up

  # ---------------------------------------------------------------------------
  # LDAP PKD DIT Initializer (runs once after MMR setup)
  # ---------------------------------------------------------------------------
  ldap-init:
    image: icao-local-pkd-openldap:1.5.0
    container_name: icao-local-pkd-ldap-init
    depends_on:
      openldap1:
        condition: service_healthy
      openldap2:
        condition: service_healthy
      ldap-mmr-setup1:
        condition: service_completed_successfully
      ldap-mmr-setup2:
        condition: service_completed_successfully
    environment:
      - LDAP_HOST=openldap1
      - LDAP_ADMIN_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}  # From .env file (same as LDAP_BIND_PASSWORD)
      - LDAP_BASE_DN=dc=ldap,dc=smartcoreinc,dc=com
    volumes:
      - ../openldap/scripts:/scripts:ro
    entrypoint: ["/bin/bash", "/scripts/init-pkd-dit.sh"]
    networks:
      - pkd-network
    restart: "no"

  # ---------------------------------------------------------------------------
  # OpenLDAP Node 1 (MMR Master - Shared)
  # ---------------------------------------------------------------------------
  openldap1:
    build:
      context: ../openldap
      dockerfile: Dockerfile
    image: icao-local-pkd-openldap:1.5.0
    container_name: icao-local-pkd-openldap1
    hostname: openldap1
    command: --copy-service
    ports:
      - "3891:389"
    environment:
      - LDAP_ORGANISATION=SmartCore Inc
      - LDAP_DOMAIN=ldap.smartcoreinc.com
      - LDAP_BASE_DN=dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}  # From .env file
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}  # From .env file
      - LDAP_READONLY_USER=false
      - LDAP_TLS=false
    volumes:
      - ../.docker-data/openldap1/data:/var/lib/ldap
      - ../.docker-data/openldap1/config:/etc/ldap/slapd.d
    networks:
      - pkd-network
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "", "-s", "base"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 60s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # OpenLDAP Node 2 (MMR Master - Shared)
  # ---------------------------------------------------------------------------
  openldap2:
    image: icao-local-pkd-openldap:1.5.0
    container_name: icao-local-pkd-openldap2
    hostname: openldap2
    command: --copy-service
    ports:
      - "3892:389"
    environment:
      - LDAP_ORGANISATION=SmartCore Inc
      - LDAP_DOMAIN=ldap.smartcoreinc.com
      - LDAP_BASE_DN=dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}  # From .env file
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}  # From .env file
      - LDAP_READONLY_USER=false
      - LDAP_TLS=false
    volumes:
      - ../.docker-data/openldap2/data:/var/lib/ldap
      - ../.docker-data/openldap2/config:/etc/ldap/slapd.d
    networks:
      - pkd-network
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "", "-s", "base"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 60s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # OpenLDAP MMR Setup (runs once to configure Multi-Master Replication)
  # ---------------------------------------------------------------------------
  ldap-mmr-setup1:
    image: icao-local-pkd-openldap:1.5.0
    container_name: icao-local-pkd-ldap-mmr-setup1
    depends_on:
      openldap1:
        condition: service_healthy
      openldap2:
        condition: service_healthy
    environment:
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}  # From .env file
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}    # From .env file
      - SERVER_ID=1
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Wait for both LDAP servers
        sleep 5

        # Run MMR setup on openldap1
        export LDAP_URI="ldap://openldap1:389"

        echo "Setting up MMR on openldap1 (Server ID: 1)..."

        # Load syncprov module
        ldapmodify -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: cn=module{0},cn=config
        changetype: modify
        add: olcModuleLoad
        olcModuleLoad: syncprov
        EOF

        # Create syncprov overlay
        ldapadd -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config
        objectClass: olcOverlayConfig
        objectClass: olcSyncProvConfig
        olcOverlay: syncprov
        olcSpSessionLog: 100
        EOF

        # Set server ID
        ldapmodify -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: cn=config
        changetype: modify
        add: olcServerID
        olcServerID: 1
        EOF

        # Configure MMR replication
        ldapmodify -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: olcDatabase={1}mdb,cn=config
        changetype: modify
        add: olcSyncRepl
        olcSyncRepl: {0}rid=001 provider=ldap://openldap1:389 binddn="cn=admin,dc=ldap,dc=smartcoreinc,dc=com" bindmethod=simple credentials=$$LDAP_ADMIN_PASSWORD searchbase="dc=ldap,dc=smartcoreinc,dc=com" scope=sub schemachecking=on type=refreshAndPersist retry="30 5 300 3" timeout=1
        olcSyncRepl: {1}rid=002 provider=ldap://openldap2:389 binddn="cn=admin,dc=ldap,dc=smartcoreinc,dc=com" bindmethod=simple credentials=$$LDAP_ADMIN_PASSWORD searchbase="dc=ldap,dc=smartcoreinc,dc=com" scope=sub schemachecking=on type=refreshAndPersist retry="30 5 300 3" timeout=1
        -
        add: olcMirrorMode
        olcMirrorMode: TRUE
        EOF

        echo "MMR setup complete for openldap1"
    networks:
      - pkd-network
    restart: "no"

  ldap-mmr-setup2:
    image: icao-local-pkd-openldap:1.5.0
    container_name: icao-local-pkd-ldap-mmr-setup2
    depends_on:
      openldap1:
        condition: service_healthy
      openldap2:
        condition: service_healthy
    environment:
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}  # From .env file
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}    # From .env file
      - SERVER_ID=2
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Wait for both LDAP servers
        sleep 5

        # Run MMR setup on openldap2
        export LDAP_URI="ldap://openldap2:389"

        echo "Setting up MMR on openldap2 (Server ID: 2)..."

        # Load syncprov module
        ldapmodify -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: cn=module{0},cn=config
        changetype: modify
        add: olcModuleLoad
        olcModuleLoad: syncprov
        EOF

        # Create syncprov overlay
        ldapadd -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: olcOverlay=syncprov,olcDatabase={1}mdb,cn=config
        objectClass: olcOverlayConfig
        objectClass: olcSyncProvConfig
        olcOverlay: syncprov
        olcSpSessionLog: 100
        EOF

        # Set server ID
        ldapmodify -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: cn=config
        changetype: modify
        add: olcServerID
        olcServerID: 2
        EOF

        # Configure MMR replication
        ldapmodify -x -H $$LDAP_URI -D "cn=admin,cn=config" -w "$$LDAP_CONFIG_PASSWORD" 2>/dev/null <<EOF || true
        dn: olcDatabase={1}mdb,cn=config
        changetype: modify
        add: olcSyncRepl
        olcSyncRepl: {0}rid=001 provider=ldap://openldap1:389 binddn="cn=admin,dc=ldap,dc=smartcoreinc,dc=com" bindmethod=simple credentials=$$LDAP_ADMIN_PASSWORD searchbase="dc=ldap,dc=smartcoreinc,dc=com" scope=sub schemachecking=on type=refreshAndPersist retry="30 5 300 3" timeout=1
        olcSyncRepl: {1}rid=002 provider=ldap://openldap2:389 binddn="cn=admin,dc=ldap,dc=smartcoreinc,dc=com" bindmethod=simple credentials=$$LDAP_ADMIN_PASSWORD searchbase="dc=ldap,dc=smartcoreinc,dc=com" scope=sub schemachecking=on type=refreshAndPersist retry="30 5 300 3" timeout=1
        -
        add: olcMirrorMode
        olcMirrorMode: TRUE
        EOF

        echo "MMR setup complete for openldap2"
    networks:
      - pkd-network
    restart: "no"

  # ---------------------------------------------------------------------------
  # Swagger UI (API Documentation)
  # ---------------------------------------------------------------------------
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: icao-local-pkd-swagger
    ports:
      - "8090:8080"
    environment:
      - URLS=[{"url":"/api/docs/pkd-management.yaml","name":"PKD Management API v1.7.0"},{"url":"/api/docs/pa-service.yaml","name":"PA Service API v1.2.0"},{"url":"/api/docs/pkd-relay.yaml","name":"PKD Relay Service API v2.0.0"}]
      - URLS_PRIMARY_NAME=PKD Management API v1.7.0
    volumes:
      - ../docs/openapi:/usr/share/nginx/html/api/docs:ro
    networks:
      - pkd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# Networks
# =============================================================================
networks:
  pkd-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  oracle-data:
    name: icao-local-pkd-oracle-data
