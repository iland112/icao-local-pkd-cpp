# =============================================================================
# ICAO Local PKD - Development Docker Compose Configuration
# PA Service Refactoring Development Environment
# =============================================================================
# Purpose: Isolated pa-service development while using production infrastructure
# Branch: feature/pa-service-repository-pattern
#
# Production services used (shared):
#   - postgres (DB with existing 31,212 certificates)
#   - openldap1, openldap2 (LDAP with existing data)
#   - pkd-management (no changes needed)
#   - pkd-relay (no changes needed)
#
# Development services:
#   - pa-service-dev (refactored pa-service on port 8092)
#
# Usage:
#   # Start production services first
#   docker-compose up -d
#
#   # Then start dev pa-service
#   docker-compose -f docker-compose.dev.yml up -d
#
#   # Access dev pa-service directly
#   curl http://localhost:8092/api/health
#
#   # View logs
#   docker-compose -f docker-compose.dev.yml logs -f pa-service-dev
#
#   # Rebuild after code changes
#   docker-compose -f docker-compose.dev.yml build --no-cache pa-service-dev
#   docker-compose -f docker-compose.dev.yml up -d --force-recreate pa-service-dev
#
#   # Stop dev service
#   docker-compose -f docker-compose.dev.yml down
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PA Service Development (Repository Pattern Refactoring)
  # ---------------------------------------------------------------------------
  pa-service-dev:
    build:
      context: ..
      dockerfile: services/pa-service/Dockerfile
      args:
        - BUILD_MODE=development
    container_name: icao-local-pkd-pa-service-dev
    ports:
      - "8092:8082"  # External 8092 -> Internal 8082 (avoid conflict with production pa-service)
    environment:
      - TZ=Asia/Seoul
      - SERVICE_NAME=pa-service-dev
      - SERVER_PORT=8082
      - DB_HOST=postgres  # Use production postgres
      - DB_PORT=5432
      - DB_NAME=localpkd
      - DB_USER=pkd
      - DB_PASSWORD=${DB_PASSWORD}
      - LDAP_HOST=openldap1  # Use production LDAP primary
      - LDAP_PORT=389
      - LDAP_BIND_DN=cn=admin,dc=ldap,dc=smartcoreinc,dc=com
      - LDAP_BIND_PASSWORD=${LDAP_BIND_PASSWORD}
      - LDAP_BASE_DN=dc=download,dc=pkd,dc=ldap,dc=smartcoreinc,dc=com
      # Development mode markers
      - ENVIRONMENT=development
      - LOG_LEVEL=debug
      - AUDIT_TAG=[DEV]  # Tag all audit logs with [DEV] prefix
    volumes:
      # Mount source code for hot reload (optional - comment out for production-like build)
      # - ../services/pa-service/src:/app/src:ro
      - ../.docker-data/pa-dev-logs:/app/logs
    # Note: depends_on removed - using external production services
    # Make sure production services (postgres, openldap1, openldap2) are running first
    networks:
      - pkd-network  # Use production network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8082/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# Use production network (must exist - created by main docker-compose.yaml)
networks:
  pkd-network:
    external: true
    name: docker_pkd-network

# No volumes needed - using production postgres and openldap volumes
