# Claude Memory - ICAO Local PKD Project

**Last Updated**: 2026-01-14

---

## 개발 및 배포 원칙

### Frontend 개발 워크플로우

**중요**: Frontend 수정 시 항상 Local (AMD64)과 Luckfox (ARM64) 모두를 고려하여 코드 작성

#### 실제 작업 흐름
```bash
# 1. Frontend 코드 수정
vim frontend/src/pages/FileUpload.tsx

# 2. Local (AMD64) 빌드 및 배포
./scripts/frontend-rebuild.sh

# 3. Local 브라우저 테스트 (http://localhost:3000)
# Ctrl + Shift + R

# 4. 검증 (선택사항)
./scripts/verify-frontend-build.sh

# 5. 코드 커밋
git add .
git commit -m "fix: description"
git push
```

#### Luckfox (ARM64) 배포 (별도 작업)
- **시점**: Local 테스트 완료 + GitHub Actions 빌드 완료 후
- **방법**: `./scripts/deploy-from-github-artifacts.sh frontend`
- **주의**: 사용자가 명시적으로 요청하기 전까지 자동으로 진행하지 않음

### 핵심 원칙

1. ✅ **코드 작성**: AMD64/ARM64 모두 동작하도록 작성
2. ✅ **테스트/배포**: Local (AMD64)만 진행
3. ✅ **Luckfox 배포**: 검증 완료 후 별도 작업으로 진행

### 금지 사항

- ❌ Frontend 수정 후 `docker compose restart frontend` 사용
- ❌ Frontend 수정 후 `docker compose up -d --build frontend` 사용 (모든 서비스 빌드됨)
- ❌ Luckfox 배포를 자동으로 진행

### 권장 사항

- ✅ `./scripts/frontend-rebuild.sh` 사용 (1분 이내 완료)
- ✅ 브라우저 강제 새로고침 (Ctrl + Shift + R)
- ✅ 배포 전 `./scripts/verify-frontend-build.sh`로 검증

---

## Docker 이미지 이름 매핑

### Local (AMD64)
- Frontend: `docker-frontend:latest`
- PKD Management: `docker-pkd-management:latest`
- PA Service: `docker-pa-service:latest`
- Sync Service: `docker-sync-service:latest`

### Luckfox (ARM64)
- Frontend: `icao-local-pkd-frontend:arm64-fixed`
- PKD Management: `icao-local-management:arm64`
- PA Service: `icao-local-pa:arm64-v3`
- Sync Service: `icao-local-sync:arm64-v1.2.0`

**중요**: 이미지 이름 변경 시 `docker-compose-luckfox.yaml`도 함께 업데이트 필요

---

## 참고 문서

- [FRONTEND_BUILD_GUIDE.md](docs/FRONTEND_BUILD_GUIDE.md) - Frontend 빌드 완전 가이드
- [DEPLOYMENT_PROCESS.md](docs/DEPLOYMENT_PROCESS.md) - 전체 배포 프로세스
- [LUCKFOX_DEPLOYMENT.md](docs/LUCKFOX_DEPLOYMENT.md) - Luckfox 특화 배포
- [DOCKER_BUILD_CACHE.md](docs/DOCKER_BUILD_CACHE.md) - 빌드 캐시 문제 해결

---

## 과거 이슈 기록

### 2026-01-14: Docker Build Cache 문제
- **문제**: `docker compose restart`가 구 이미지로 재시작
- **해결**: `./scripts/frontend-rebuild.sh` 스크립트 작성
- **교훈**: 이미지 재빌드 없이는 컨테이너만 재시작됨

### 2026-01-14: MANUAL 모드 localStorage 버그
- **문제**: 페이지 새로고침 시 `totalEntries=0`인데 "파싱 완료" 표시
- **해결**: `totalEntries > 0` 조건 추가
- **위치**: [FileUpload.tsx:100-114](frontend/src/pages/FileUpload.tsx#L100-L114)

### 2026-01-14: DNS 해결 문제
- **문제**: Frontend nginx가 외부 DNS (8.8.8.8) 사용하여 api-gateway 해결 실패
- **해결**: Docker 내부 DNS (127.0.0.11) 사용
- **위치**: [nginx.conf:8](frontend/nginx.conf#L8)

### 2026-01-14: MANUAL 모드 SSE 연결 문제 (재발)
- **문제**: "파싱 시작", "저장" 버튼 클릭 시 진행 상태가 표시되지 않음
- **원인**: v1.5.5에서 해결했던 문제가 재발 - 버튼 클릭 시 SSE 재연결하지 않음
- **해결**: `triggerParse()`, `triggerValidate()` 함수에 `connectToProgressStream(uploadId)` 추가
- **위치**: [FileUpload.tsx:640, 653](frontend/src/pages/FileUpload.tsx#L640)
- **교훈**:
  - ⚠️ **Frontend 코드 수정 전 반드시 과거 이슈 확인!**
  - ⚠️ **SSE/Polling 관련 코드 수정 시 연결 로직 반드시 확인!**
  - ⚠️ **localStorage 복원 로직 수정해도 SSE 연결에 영향 없는지 확인!**

### 2026-01-14: MANUAL 모드 localStorage vs URL 파라미터 충돌
- **문제**: 새 파일 업로드 시 이전 완료된 업로드의 상태가 표시됨 ("파싱 완료 0건 처리")
- **원인**: URL `?uploadId=NEW_ID` 파라미터를 읽지 않고, localStorage의 이전 `uploadId`를 복원
- **해결**: URL 파라미터가 있으면 localStorage를 무시하고 제거
- **위치**: [FileUpload.tsx:38, 67-71](frontend/src/pages/FileUpload.tsx#L67)
- **교훈**:
  - ⚠️ **URL 파라미터가 localStorage보다 우선순위가 높아야 함!**
  - ⚠️ **페이지 로딩 시 URL과 localStorage 모두 체크하고 충돌 방지!**
  - ⚠️ **useEffect dependency에 searchParams 포함 필수!**

### 2026-01-14: Sync Service Discrepancy 값 미저장 버그
- **문제**: API가 모든 discrepancy 값을 0으로 반환 (status는 DISCREPANCY)
- **원인**: `INSERT INTO sync_status` 쿼리에 discrepancy 컬럼 누락
- **해결**: 5개 discrepancy 컬럼 추가 (csca, dsc, dsc_nc, crl, total), 파라미터 수 15→20 변경
- **위치**: [sync-service/main.cpp:319-353](services/sync-service/src/main.cpp#L319)
- **교훈**:
  - ⚠️ **INSERT 쿼리 작성 시 모든 컬럼 확인!**
  - ⚠️ **파라미터 배열 크기와 실제 컬럼 수 일치 확인!**

### v1.5.5 해결 이슈 (참고용)
- **SSE 연결 및 Polling 백업**:
  - SSE 연결 실패 시 polling으로 fallback
  - MANUAL 모드 버튼 클릭 시 SSE 재연결 필요
  - `connectToProgressStream()` 호출 위치 중요

---

## 기능 설계 문서

### Auto Reconcile (2026-01-14)
- **설계 문서**: [docs/AUTO_RECONCILE_DESIGN.md](docs/AUTO_RECONCILE_DESIGN.md)
- **목적**: PostgreSQL-LDAP 불일치 자동 해소
- **현재 상태**: 설계 완료, 구현 예정 (main.cpp:1130 TODO)
- **구현 계획**: 5단계 (Core Logic → DB Schema → API → Frontend → Scheduler)
- **주요 기능**:
  - DB에만 존재 → LDAP 추가
  - LDAP에만 존재 → LDAP 삭제
  - Batch 처리 (maxReconcileBatchSize=100)
  - Audit logging (reconciliation_log 테이블)
  - Dry-run 모드 지원

---

## 주의사항

### 코드 수정 전 필수 확인 사항 ⚠️

**CRITICAL**: 코드 수정 전 반드시 아래 순서로 확인할 것!

1. **과거 이슈 확인** (가장 중요!)
   - `.claude-memory.md` 파일의 "과거 이슈 기록" 섹션 확인
   - `CLAUDE.md`의 Change Log 확인
   - 같은 문제를 이미 해결했는지 확인

2. **관련 코드 전체 확인**
   - 수정하려는 파일의 전체 맥락 이해
   - 관련된 다른 파일들도 함께 확인
   - SSE, Polling, Event Handler 등 연관 기능 확인

3. **영향 범위 분석**
   - MANUAL/AUTO 모드 모두 영향받는지 확인
   - SSE 연결, Polling 로직에 영향 없는지 확인
   - 이전 버전에서 해결한 버그를 다시 발생시키지 않는지 확인

4. **수정 후 검증**
   - Frontend 코드 수정 시 항상 TypeScript 타입 체크 확인
   - 브라우저 개발자 도구 콘솔 오류 확인 필수
   - MANUAL/AUTO 모드 모두 테스트
   - Git 커밋 전 빌드 성공 확인

### 절대 하지 말아야 할 것 🚫

- ❌ 과거 해결한 이슈를 확인하지 않고 코드 수정
- ❌ 일부 코드만 보고 전체 맥락 없이 수정
- ❌ SSE/Polling 관련 코드 건드리면서 연결 로직 확인 안 함
- ❌ MANUAL 모드만 테스트하고 AUTO 모드 테스트 생략 (또는 반대)
