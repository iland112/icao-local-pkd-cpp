# =============================================================================
# HAProxy Configuration for OpenLDAP Load Balancing
# =============================================================================
# Issue Fixed: LDAP connection pooling and stale connection problems
# Solution: Shorter timeouts, forced session shutdown, TCP keepalive health checks
# References:
# - https://www.loadbalancer.org/applications/ldap-servers/
# - https://community.cisco.com/t5/network-access-control/acs-4-2-ldap-tcp-keepalive/td-p/1634467
# =============================================================================

global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull

    # CRITICAL: Shorter timeouts to prevent stale connection reuse
    # libldap connection pools must refresh before HAProxy times out
    timeout connect 5000ms
    timeout client 30000ms      # Reduced from 50s to 30s
    timeout server 30000ms      # Reduced from 50s to 30s
    timeout check 5000ms        # Health check timeout

    retries 3

# =============================================================================
# LDAP Frontend (Port 389)
# =============================================================================
frontend ldap_frontend
    bind *:389
    default_backend ldap_backend

# =============================================================================
# LDAP Backend (Round-Robin) with Connection Management
# =============================================================================
backend ldap_backend
    balance roundrobin

    # TCP health check with LDAP bind simulation
    option tcp-check
    tcp-check connect

    # CRITICAL: Force close client connections when backend fails
    # This prevents libldap from reusing connections to dead backends
    # Reference: https://www.loadbalancer.org/applications/ldap-servers/
    server openldap1 openldap1:389 check inter 10s fall 3 rise 2 on-marked-down shutdown-sessions
    server openldap2 openldap2:389 check inter 10s fall 3 rise 2 on-marked-down shutdown-sessions

    # inter 10s: Health check every 10 seconds (increased from 5s) to keep connections alive
    # fall 3: Mark server down after 3 consecutive failures
    # rise 2: Mark server up after 2 consecutive successes
    # on-marked-down shutdown-sessions: CRITICAL - force close all client sessions when backend fails

# =============================================================================
# HAProxy Stats UI (Port 8404)
# =============================================================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
